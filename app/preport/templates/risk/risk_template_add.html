{% extends 'home/template.html' %}

{% load i18n %}

{% block title %} {% translate "Risk Add Templates" %} {% endblock title %}

{% block stylesheets %}
  {{ block.super }}
{% endblock stylesheets %}

{% block content %}


<section class="content-header">
  <div class="container-fluid">
    <div class="row mb-2">
      <div class="col-sm-6">
        <h1></h1>
      </div>
      <div class="col-sm-6">
        <ol class="breadcrumb float-sm-right">
          <li class="breadcrumb-item"><a href="/">{% translate "Home" %}</a></li>
          <li class="breadcrumb-item"><a href="/risk/risk_template_list/">{% translate "Risk" %}</a></li>
          <li class="breadcrumb-item active">{% translate "Add Risk" %}</li>
        </ol>
      </div>
    </div>
  </div>
</section>


<section class="content">
    <div class="container-fluid">
      <div class="row">
        <div class="col-md-12">

            <div class="card card-outline card-primary">
              <div class="card-header">
                <h3 class="card-title">{% translate "Risk Register" %}</h3>
              </div>
              

              <form role="form" method="post" enctype="multipart/form-data">
                {% csrf_token %}
                <div class="card-body">

                  <div class="form-group row">
                    <label class="col-sm-2 col-form-label">{% translate "Risk Number" %}</label>
                      <div class="col-md-10 col-sm-10 col-xs-12">
                        {{ form.risk_number }}
                      </div>
                  </div>


                  <div class="form-group row">
                    <label class="col-sm-2 col-form-label">{% translate "Risk Owner" %}</label>
                    <div class="col-md-10 col-sm-10 col-xs-12">
                      {{ form.risk_owner }}
                    </div>
                  </div>
   
                  <div class="form-group row">
                    <label class="col-sm-2 col-form-label">{% translate "Process Service Name" %}</label>
                    <div class="col-md-10 col-sm-10 col-xs-12">
                      {{ form.process_service_name }}
                    </div>
                  </div>
                  
                  <div class="form-group row">
                    <label class="col-sm-2 col-form-label">{% translate "Asset Category" %}</label>
                    <div class="col-md-10 col-sm-10 col-xs-12">
                      {{ form.asset_category }}
                    </div>
                  </div>

                  <div class="form-group row">
                    <label class="col-sm-2 col-form-label">{% translate "Asset Name" %}</label>
                    <div class="col-md-10 col-sm-10 col-xs-12">
                      {{ form.asset_name }}
                    </div>
                  </div>

                  <div class="form-group row">
                    <label class="col-sm-2 col-form-label">Threat</label>
                    <div class="col-md-10 col-sm-10 col-xs-12">
                      {{ form.threat }}
                    </div>
                  </div>

                  <div class="form-group row">
                    <label class="col-sm-2 col-form-label">Vulnerability</label>
                    <div class="col-md-10 col-sm-10 col-xs-12">
                      {{ form.vulnerability }}
                    </div>
                  </div>

                  <div class="form-group row">
                    <label class="col-sm-2 col-form-label">Impact Component</label>
                    <div class="col-md-10 col-sm-10 col-xs-12">
                      {{ form.impact_component }}
                    </div>
                  </div>

                  <div class="form-group row">
                    <label class="col-sm-2 col-form-label">Current Control</label>
                    <div class="col-md-10 col-sm-10 col-xs-12">
                      {{ form.current_control }}
                    </div>
                  </div>

                  <div class="form-group row">
                    <label class="col-sm-2 col-form-label">{% translate "Inherent Risk Probability" %}</label>
                    <div class="col-md-10 col-sm-10 col-xs-12" style="display: block;">
                      {{ form.inherent_risk_probability }}
                    </div>
                  </div>

                  <div class="form-group row">
                    <label class="col-sm-2 col-form-label">{% translate "Inherent Risk Severity" %}</label>
                    <div class="col-md-10 col-sm-10 col-xs-12" style="display: block;">
                      {{ form.inherent_risk_severity }}
                    </div>
                  </div>

                  <div class="form-group row">
                    <label class="col-sm-2 col-form-label">{% translate "Inherent Risk Value" %}</label>
                    <div class="col-md-10 col-sm-10 col-xs-12" style="display: block;">
                      {{ form.inherent_risk_value }}
                    </div>
                  </div>

                  <div class="form-group row">
                    <label class="col-sm-2 col-form-label">{% translate "Type of Risk" %}</label>
                    <div class="col-md-10 col-sm-10 col-xs-12" style="display: block;">
                      {{ form.type_of_risk }}
                    </div>
                  </div>

                  <div class="form-group row">
                    <label class="col-sm-2 col-form-label">{% translate "Risk Handling" %}</label>
                    <div class="col-md-10 col-sm-10 col-xs-12" style="display: block;">
                      {{ form.risk_handling }}
                    </div>
                  </div>

                  <div class="form-group row">
                    <label class="col-sm-2 col-form-label">Risk Treatment Plan</label>
                    <div class="col-md-10 col-sm-10 col-xs-12">
                      {{ form.risk_treatment_plan }}
                    </div>
                  </div>

                  <div class="form-group row">
                    <label class="col-sm-2 col-form-label">{% translate "Residual Risk Probability" %}</label>
                    <div class="col-md-10 col-sm-10 col-xs-12" style="display: block;">
                      {{ form.residual_risk_probability }}
                    </div>
                  </div>

                  <div class="form-group row">
                    <label class="col-sm-2 col-form-label">{% translate "Residual Risk Severity" %}</label>
                    <div class="col-md-10 col-sm-10 col-xs-12" style="display: block;">
                      {{ form.residual_risk_severity }}
                    </div>
                  </div>

                  <div class="form-group row">
                    <label class="col-sm-2 col-form-label">{% translate "Residual Risk Value" %}</label>
                    <div class="col-md-10 col-sm-10 col-xs-12" style="display: block;">
                      {{ form.residual_risk_value }}
                    </div>
                  </div>

                  <div class="form-group row">
                    <label class="col-sm-2 col-form-label">Reference</label>
                    <div class="col-md-10 col-sm-10 col-xs-12">
                      {{ form.reference }}
                    </div>
                  </div>

                  <div class="form-group row">
                    <label class="col-sm-2 col-form-label">{% translate "Target Date" %}</label>
                      <div class="col-md-10 col-sm-10 col-xs-12">
                        {{ form.target_date }}
                      </div>
                  </div>

                  <div class="form-group row">
                    <label class="col-sm-2 col-form-label">{% translate "Status" %}</label>
                    <div class="col-md-10 col-sm-10 col-xs-12" style="display: block;">
                      {{ form.status }}
                    </div>
                  </div>

                </div>

                {% if form.errors %}
                   {% for field in form %}
                       {% for error in field.errors %} 
                          <div class="container">
                            <div class="col-md-12 col-sm-12 col-xs-12">
                              <div class="alert alert-danger alert-dismissible ">
                              <button type="button" class="close" data-dismiss="alert" aria-hidden="true">Ã—</button>
                              <h5><i class="icon fas fa-ban"></i> Error</h5>
                              {{ field.name }}: {{ error|escape }}
                              </div>
                            </div>
                          </div>
                       {% endfor %}
                   {% endfor %}
                {% endif %}
                
                <div class="card-footer">
                  <button type="submit" class="btn btn-success" value="Save" name="_finish">Save and finish</button>
                  <button type="submit" class="btn btn-primary" value="Next" name="_next">Save and add a new template</button>
                </div>

              </form>
            </div>


        </div>
      </div>
    </div>
</section>




{% endblock content %}




{% block javascripts %}
  {{ block.super}}

  <script nonce="" type="text/javascript" async="async" src="/static/cvsscalc31.js"></script>
  <script nonce="" type="text/javascript" async="async" src="/static/cvsscalc31_helptext.js"></script>


<script type="text/javascript">

"use strict";

const language = navigator.language;

function updateScores() {
    var result = CVSS31.calculateCVSSFromMetrics(inputValue('input[type="radio"][name=AV]:checked'), inputValue('input[type="radio"][name=AC]:checked'), inputValue('input[type="radio"][name=PR]:checked'), inputValue('input[type="radio"][name=UI]:checked'), inputValue('input[type="radio"][name=S]:checked'), inputValue('input[type="radio"][name=C]:checked'), inputValue('input[type="radio"][name=I]:checked'), inputValue('input[type="radio"][name=A]:checked'), inputValue('input[type="radio"][name=E]:checked'), inputValue('input[type="radio"][name=RL]:checked'), inputValue('input[type="radio"][name=RC]:checked'), inputValue('input[type="radio"][name=CR]:checked'), inputValue('input[type="radio"][name=IR]:checked'), inputValue('input[type="radio"][name=AR]:checked'), inputValue('input[type="radio"][name=MAV]:checked'), inputValue('input[type="radio"][name=MAC]:checked'), inputValue('input[type="radio"][name=MPR]:checked'), inputValue('input[type="radio"][name=MUI]:checked'), inputValue('input[type="radio"][name=MS]:checked'), inputValue('input[type="radio"][name=MC]:checked'), inputValue('input[type="radio"][name=MI]:checked'), inputValue('input[type="radio"][name=MA]:checked'));
    if (result.success === true) {

        document.getElementById("id_cvss_base_score").value = result.baseMetricScore + " (" + result.vectorString + ")";
        document.getElementById("id_severity").value = result.baseSeverity;
        document.getElementById("id_cvss_score").value = result.baseMetricScore;


        var L = document.querySelectorAll(".needBaseMetrics"), i = L.length;
        while (i--) {
            hide(L[i]);
        }
        parentNode(text("#baseMetricScore", result.baseMetricScore), ".scoreRating").className = "scoreRating " + result.baseSeverity.toLowerCase();
        text("#baseSeverity", "(" + result.baseSeverity + ")");
        parentNode(text("#temporalMetricScore", result.temporalMetricScore), ".scoreRating").className = "scoreRating " + result.temporalSeverity.toLowerCase();
        text("#temporalSeverity", "(" + result.temporalSeverity + ")");
        parentNode(text("#environmentalMetricScore", result.environmentalMetricScore), ".scoreRating").className = "scoreRating " + result.environmentalSeverity.toLowerCase();
        text("#environmentalSeverity", "(" + result.environmentalSeverity + ")");
        show(inputValue("#vectorString", result.vectorString));
        window.location.hash = result.vectorString;
    } else {
        if (result.error === "Not all base metrics were given - cannot calculate scores.") {
            var L = document.querySelectorAll(".needBaseMetrics"), i = L.length;
            while (i--) {
                show(L[i]);
            }
            hide("#vectorString");
        }
    }
}

function delayedUpdateScores() {
    setTimeout(updateScores, 100);
}

window.Element && function (ElementPrototype) {
    ElementPrototype.matchesSelector = ElementPrototype.matchesSelector || ElementPrototype.mozMatchesSelector || ElementPrototype.msMatchesSelector || ElementPrototype.oMatchesSelector || ElementPrototype.webkitMatchesSelector || function (selector) {
        var node = this,
            nodes = (node.parentNode || node.document).querySelectorAll(selector),
            i = -1;
        while (nodes[++i] && nodes[i] != node) {
        }
        return !!nodes[i];
    };
}(Element.prototype);
var matchesSelector = function (node, selector) {
    if (!("parentNode" in node) || !node.parentNode) {
        return false;
    }
    return Array.prototype.indexOf.call(node.parentNode.querySelectorAll(selector)) != -1;
};

function node() {
    for (var i = 0; i < arguments.length; i++) {
        var o = arguments[i];
        if (typeof (o) == "string" && o) {
            return document.querySelector(o);
        } else {
            if ("nodeName" in o) {
                return o;
            } else {
                if ("jquery" in o) {
                    return o.get(0);
                }
            }
        }
    }
    return false;
}

function parentNode(p, q) {
    if (!p || !(p = node(p))) {
        return;
    } else {
        if ((typeof (q) == "string" && p.matchesSelector(q)) || p == q) {
            return p;
        } else {
            if (p.nodeName.toLowerCase() != "html") {
                return parentNode(p.parentNode, q);
            } else {
                return;
            }
        }
    }
}

function bind(q, tg, fn) {
    var o = node(q);
    if (!o) {
        return;
    }
    if (o.addEventListener) {
        o.addEventListener(tg, fn, false);
    } else {
        if (o.attachEvent) {
            o.attachEvent("on" + tg, fn);
        } else {
            o["on" + tg] = fn;
        }
    }
    return o;
}

function text(q, s) {
    var e = node(q);
    if (!e) {
        return;
    }
    if (arguments.length > 1) {
        if ("textContent" in e) {
            e.textContent = s;
        } else {
            e.innerText = s;
        }
        return e;
    }
    return e.textContent || e.innerText;
}

function hide(q) {
    var e = node(q);
    if (!e) {
        return;
    }
    e.setAttribute("style", "display:none");
    return e;
}

function show(q) {
    var e = node(q);
    if (!e) {
        return;
    }
    e.setAttribute("style", "display:inline-block");
    return e;
}

function inputValue(q, v) {
    var e = document.querySelector(q);
    if (!e || e.nodeName.toLowerCase() != "input") {
        return;
    }
    if (arguments.length > 1) {
        e.value = v;
        return e;
    }
    return e.value;
}

function setMetricsFromVector(vectorString) {
    var result = true;
    var urlMetric;
    var metricValuesToSet = {
        AV: undefined,
        AC: undefined,
        PR: undefined,
        UI: undefined,
        S: undefined,
        C: undefined,
        I: undefined,
        A: undefined,
        E: "X",
        RL: "X",
        RC: "X",
        CR: "X",
        IR: "X",
        AR: "X",
        MAV: "X",
        MAC: "X",
        MPR: "X",
        MUI: "X",
        MS: "X",
        MC: "X",
        MI: "X",
        MA: "X",
    };
    var vectorStringRegex_31 = /^CVSS:3.1\/((AV:[NALP]|AC:[LH]|PR:[UNLH]|UI:[NR]|S:[UC]|[CIA]:[NLH]|E:[XUPFH]|RL:[XOTWU]|RC:[XURC]|[CIA]R:[XLMH]|MAV:[XNALP]|MAC:[XLH]|MPR:[XUNLH]|MUI:[XNR]|MS:[XUC]|M[CIA]:[XNLH])\/)*(AV:[NALP]|AC:[LH]|PR:[UNLH]|UI:[NR]|S:[UC]|[CIA]:[NLH]|E:[XUPFH]|RL:[XOTWU]|RC:[XURC]|[CIA]R:[XLMH]|MAV:[XNALP]|MAC:[XLH]|MPR:[XUNLH]|MUI:[XNR]|MS:[XUC]|M[CIA]:[XNLH])$/;
    if (vectorStringRegex_31.test(vectorString)) {
        var urlMetrics = vectorString.substring("CVSS:3.1/".length).split("/");
        for (var p in urlMetrics) {
            var urlMetric = urlMetrics[p].split(":");
            metricValuesToSet[urlMetric[0]] = urlMetric[1];
        }
        if (metricValuesToSet.AV !== undefined && metricValuesToSet.AC !== undefined && metricValuesToSet.PR !== undefined && metricValuesToSet.UI !== undefined && metricValuesToSet.S !== undefined && metricValuesToSet.C !== undefined && metricValuesToSet.I !== undefined && metricValuesToSet.A !== undefined) {
            for (var p in metricValuesToSet) {
                document.getElementById(p + "_" + metricValuesToSet[p]).checked = true;
            }
        } else {
            result = "NotAllBaseMetricsProvided";
        }
    } else {
        result = "MalformedVectorString";
    }
    updateScores();
    return result;
}

var CVSSVectorInURL;

function urlhash() {
    var h = window.location.hash;
    CVSSVectorInURL = h;
    setMetricsFromVector(h.substring(1));
}

function inputSelect() {
    this.setSelectionRange(0, this.value.length);
}

function cvssCalculator() {
    if (!("CVSS31" in window) || !("CVSS31_Help" in window)) {
        setTimeout(cvssCalculator, 100);
        return;
    }

    const helpText = CVSS31_Help[`helpText_${language}`] || CVSS31_Help[`helpText_en-US`];

    var L, i, n;
    L = document.querySelectorAll(".cvss-calculator input");
    i = L.length;
    while (i--) {
        bind(L[i], "click", delayedUpdateScores);
    }
    for (n in helpText) {
        document.getElementById(n).setAttribute("title", helpText[n]);
    }
    urlhash();
    if (("onhashchange" in window)) {
        window.onhashchange = urlhash;
    }
    bind(bind("#vectorString", "click", inputSelect), "contextmenu", inputSelect);
}



cvssCalculator();


</script>



<script>
// In your Javascript (external .js resource or <script> tag)
$(document).ready(function() {
    $('.select2CWE').select2();
});
</script>
{% endblock javascripts %}

